# Entity Migration

## Rules
1. ALWAYS, ALWAYS AGAIN relocate and migrate EACH property!
2. Be patient and accurate when relocate entities
3. Follow conventions there are different between CUBA Platform and Jmix 2. 
4. Follow snippets below! LLM have to follow each.

## Name convention

```
@Table(name = "SALES_CUSTOMER")  <- Table in DB name
@Entity(name = "Customer")   <- Entity name in metadata
```

If we working no module, then append module's prefix into Entity's meta-name

e.g. if Store (DataSource) named `@Store(name = "addncompany")`
then name entity `@Entity(name = "addncompany_NewEntity")`

## Base Entity Structure
```java
// CUBA  
@Entity(name = "sales\$Customer")  
@Table(name = "SALES_CUSTOMER")  
public class Customer extends StandardEntity {  

    private static final long serialVersionUID = -123456789L;  

    @Column(name = "NAME")  
    private String name;  

}  
```

```java
// Jmix  
@JmixEntity  
@Table(name = "SALES_CUSTOMER")  
@Entity(name = "Customer")  
public class Customer {  

    @JmixGeneratedValue  
    @Id  
    @Column(name = "ID", nullable = false)  
    private UUID id;  

    @InstanceName  
    @Column(name = "NAME")  
    private String name;  

    // ...
}
```

## Critical Migration Rules

### 1. Annotations Strategy
```java
// ❌ WRONG - Don't add unnecessary annotations  
@JmixEntity  
@Entity  
@Table(name = "CUSTOMER")  
@MetaClass(name = "sales_Customer") // ← REMOVE this  
public class Customer {  
    //...
}  
```
```java
// ✅ CORRECT - Minimal required annotations  
@JmixEntity  
@Table(name = "CUSTOMER")  
@Entity(name = "sales_Customer")  
public class Customer {  
    //...
}
```

### 2. Embedded Entities
```java
// CUBA  
public class Address {  
    @Column(name = "STREET")  
    private String street;  
    @Column(name = "CITY")  
    private String city;  
}  


@Entity(name = "sales_Customer")  
public class Customer extends StandardEntity {  
    @EmbeddedParameters(nullAllowed = false)
    @AttributeOverrides({
            @AttributeOverride(name = "street", column = @Column(name = "STREET")),
            @AttributeOverride(name = "city", column = @Column(name = "CITY"))
    })
    @Embedded  
    private Address address;  
}  
```

```java
// Jmix  
@JmixEntity // ← CRITICAL: Don't forget this!  
@Embeddable  
public class Address {  
        @Column(name = "STREET")  
        private String street;  
        @Column(name = "CITY")  
        private String city;  
}  

@JmixEntity  
@Entity(name = "Customer")  
public class Customer {  

        @EmbeddedParameters(nullAllowed = false)
        @AttributeOverrides({
                @AttributeOverride(name = "street", column = @Column(name = "STREET")),
                @AttributeOverride(name = "city", column = @Column(name = "CITY"))
        })
        @Embedded  
        private Address address;
  
}
```

### 3. Enums - No Custom Converters Needed

```Java
// ✅ CORRECT - Implement EnumClass. Also can be generated by Jmix Studio
public enum BookingChannelEnum implements EnumClass<String> {  
    WEB("web"),  
    APP("app"),  
    TBS("tbs");  

    private String id;  

    BookingChannelEnum(String value) {  
        this.id = value;  
    }  

    public String getId() {  
        return id;  
    }  

    @Nullable  
    public static BookingChannelEnum fromId(String id) {  
       for (BookingChannelEnum en : BookingChannelEnum.values()) {
            if (en.getId().equals(id)) {
                return en;
            }
        }
        return null;
    }  
}  


// IMPORTANT: Import from io.jmix.core.metamodel.datatype.impl.EnumUtils  
import io.jmix.core.metamodel.datatype.impl.EnumUtils;  

// Entity field  
@NotNull  
@Column(name = "CHANNEL_TYPE")  
private String channelType;  

// Getter/Setter with enum conversion  
public BookingChannelEnum getChannelType() {  
    return EnumUtils.fromId(BookingChannelEnum.class, channelType);  
}  

public void setChannelType(BookingChannelEnum channelType) {  
    this.channelType = (channelType == null ? null : channelType.getId());  
}

// Also valid jmix way (generated by Jmix Studio) getters & setters
public BookingChannelEnum getChannelType() {
    return channelType == null ? null : BookingChannelEnum.fromId(channelType);
}

public void setChannelType(BookingChannelEnum channelTypeVal) {
    this.channelType = channelTypeVal == null ? null : channelTypeVal.getId();
}
```

### 4. Entity Metadata & Messages
Each JmixProperties HAVE TO BE MIGRATED. No understand errors we can invoke mcp idea - `get_file_problems`. But before open file in editor via also mcp, wait 2-3 seconds, then run get problems. IDEA is lazy on problem loading and without opening it can show nothing.

**Don't forget to migrate messages!** They are located in the same folder as entity classes.
```messages
# CUBA messages.properties  
SupplierZone=Supplier zones
SupplierZone.id=ID
SupplierZone.version=Version
SupplierZone.createTs=Create TS
SupplierZone.createdBy=Created by
SupplierZone.updateTs=Update TS
SupplierZone.updatedBy=Updated by
SupplierZone.deleteTs=Delete TS
SupplierZone.deletedBy=Deleted by
SupplierZone.supplier=Supplier
SupplierZone.zoneId=Zone id
SupplierZone.zone=Zone
/SupplierZone.supplierZoneProducts=Supplier Zone Products
```

```messages
\# Jmix messages.properties (remove sales\$ prefix)  
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone=Supplier zones
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.id=ID
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.version=Version
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.createTs=Create TS
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.createdBy=Created by
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.updateTs=Update TS
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.updatedBy=Updated by
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.deleteTs=Delete TS
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.deletedBy=Deleted by
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.supplier=Supplier
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.zoneId=Zone id
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.zone=Zone
com.haulmont.shamrock.affiliatesregistry.entity.partner.supplier/SupplierZone.supplierZoneProducts=Supplier zone products
```

### 5. InstanceName Replacement
```java
// CUBA  
@NamePattern("%s|name")  
public class Customer extends StandardEntity {  
    @Column(name = "NAME")  
    private String name;  
}  
```

```java
// Jmix - Simple instance name  
@JmixEntity  
@Entity(name = "Customer")  
public class Customer {  
    @InstanceName  
    @Column(name = "NAME")  
    private String name;  
}  
// Jmix - Complex patterns with method  
@JmixEntity  
@Entity(name = "Customer")  
public class Customer {  
    @InstanceName
    @DependsOnProperties({"code", "name"})
    public String getInstanceName(MetadataTools metadataTools) {
        return String.format("%s=%s",
                metadataTools.format(name),
                metadataTools.format(code));
    }
}  
```

### 6. Validation Annotations

```java
// CUBA  
@Column(name = "EMAIL", length = 100)  
@NotNull  
private String email;  
```
```java
// Jmix - Use Bean Validation annotations  
@Column(name = "EMAIL", length = 100)  
@NotNull  
@Email  
private String email;
```

### 7. Remove Obsolete Elements

- Remove serialVersionUID (unnecessary in Jmix)
- Remove extends StandardEntity
- Remove @MetaClass annotations

### 8. MetaProperties

- MetaProperties in Jmix replaced with JmixProperty;
- JmixProperty redundant if no parameters passed;

e.g. 

```java
// CUBA
@Transient
@NotNull
@MetaProperty(mandatory = true)
protected Product product;
```

```
// Jmix
@JmixProperty(mandatory = true)
@Transient
@NotNull
protected Product product; 
```

No mandatory:
```java
@Transient
@NotNull
@MetaProperty
protected Product product;
```

```java
// Jmix -> no @JmixProperty need, already "annotated" @JmixProperty(mandatory = false)
@Transient
@NotNull
protected Product product; 
```

### Jmix DTOs / not persisted entities

```java
@JmixEntity(name = "codecmpny_ZoneCountry")
public class ZoneCountry {

    @JmixGeneratedValue
    @JmixId
    private String id; 

    @InstanceName
    @JmixProperty(mandatory = true)
    @Size(min = 2, max = 3)
    private String code;

    // getters and setters
}
```

### Inheritance

Inheritance same in CUBA and Jmix, just JAKARTA RULES

```java
@Store(name = "codecompny")
@JmixEntity
@Inheritance(strategy = InheritanceType.JOINED)
@DiscriminatorColumn(name = "PARTNER_TYPE", discriminatorType = DiscriminatorType.STRING)
@Table(name = "PARTNER")
@Entity(name = "codecompny_Partner")
public class Partner {
    // fields
}
```
